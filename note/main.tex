\documentclass[12pt]{article}

\usepackage{answers}
\usepackage{setspace}
\usepackage{graphicx}
\usepackage{enumitem}
\usepackage{multicol}
\usepackage{mathrsfs}
\usepackage[margin=1in]{geometry} 
\usepackage{amsmath,amsthm,amssymb}
 
\newcommand{\N}{\mathbb{N}}
\newcommand{\Z}{\mathbb{Z}}
\newcommand{\C}{\mathbb{C}}
\newcommand{\R}{\mathbb{R}}

\DeclareMathOperator{\sech}{sech}
\DeclareMathOperator{\csch}{csch}
 
\begin{document}
 
% --------------------------------------------------------------
%                         Start here
% --------------------------------------------------------------
 
\title{CCA with Ledoit-Wolf}%replace with the appropriate homework number
\author{Guohao Dou} %if necessary, replace with your course title
 
\maketitle
$\nabla_{11}, \nabla_{22}$ and $\nabla_{12}$ remains the same, since 
\[\nabla = \frac{\partial f}{\partial \hat\Sigma}\]
and we haven't changed how we get from estimated covariance to trace norm of $T$.\\

However, now that 
\[\hat\Sigma_{11} = (1-s)\Sigma_{11} + s\mu I\]
where $\Sigma_{11} = H_1H_1^T / m$ is the sample covariance matrix, $\mu = \text{tr}(\Sigma_{11})/D$. $s$ is the shrinkage factor estimated from $\Sigma_{11}$. We should note that mathematically, $s, \mu$ both depend on $\Sigma_{11}$. However, I would like to treat $s$ as an external variable unrelated to $\Sigma_{11}$, at least for now. \\

First consider $a \neq b$. This one is easy since $\hat\Sigma_{ab}^{11} = (1-s)\Sigma^{11}_{ab}$. 
\[
\frac{\partial \hat\Sigma^{11}_{ab}}{\partial \Sigma^{11}_{cd}} = \left.
\begin{cases}
  1 - s, & \text{for } a = c \;\&\; b = d \\
  0, & \text{otherwise}
\end{cases}
\right\} = (1 - s)\cdot \delta_{ac}\cdot \delta_{bd}
\]

Then consider $a = b$. Now $\hat\Sigma_{ab}^{11} = (1-s)\Sigma^{11}_{aa} + s\mu = (1-s)\Sigma^{11}_{aa} + \frac{s}{D}\sum_{i=1}^d \Sigma_{ii}^{11}$
\[
\frac{\partial \hat\Sigma^{11}_{aa}}{\partial \Sigma^{11}_{cd}} = \left.
\begin{cases}
  (1 - s) + s/D, & \text{for } a = c \;\&\; c = d \\
  s/D, & \text{for } c = d \\
  0, & \text{otherwise}
\end{cases}
\right\} = (1 - s)\cdot \delta_{ac}\cdot\delta_{cd} + \frac{s}{D}\cdot \delta_{cd}
\]

In the DeepCCA paper, both $(\nabla_{11})_{ab} = \frac{\partial f}{\partial \hat\Sigma^{11}_{ab}}$ and $\frac{\partial \Sigma^{11}_{cd}}{\partial H^1_{ij}}$ has been given. $\frac{\partial \hat\Sigma^{11}_{ab}}{\partial\Sigma^{11}_{cd}}$ will be the final piece.

Then 
\begin{align*}
  \frac{\partial f}{\partial H^1_{ij}} 
&= \sum_{ab}\nabla^{11}_{ab}\frac{\hat\Sigma^{11}_{ab}}{H^1_{ij}} 
  + \sum_{ab} \nabla^{12}_{ab}\frac{\partial\hat\Sigma^{12}_{ab}}{\partial H^1_{ij}}\\
&= \sum_{ab}\nabla^{11}_{ab} \sum_{cd}\frac{\partial \hat\Sigma_{ab}^{11}}{\partial \Sigma_{cd}^{11}} \frac{\partial \Sigma^{11}_{cd}}{\partial H^1_{ij}}
  + \sum_{ab} \nabla^{12}_{ab}\frac{\partial\hat\Sigma^{12}_{ab}}{\partial H^1_{ij}}
\end{align*}

The second term should stay the same, since we haven't changed the way to estimate cross-covariance. So let's look at the first term only.

\begin{align*}
&\sum_{ab}\nabla^{11}_{ab} \sum_{cd}\frac{\partial \hat\Sigma_{ab}^{11}}{\partial \Sigma_{cd}^{11}} \frac{\partial \Sigma^{11}_{cd}}{\partial H^1_{ij}} \\
&= \sum_{ab, a\neq b}\nabla^{11}_{ab} \sum_{cd}\frac{\partial \hat\Sigma_{ab}^{11}}{\partial \Sigma_{cd}^{11}} \frac{\partial \Sigma^{11}_{cd}}{\partial H^1_{ij}}
  + \sum_{a}\nabla^{11}_{aa} \sum_{cd}\frac{\partial \hat\Sigma_{aa}^{11}}{\partial \Sigma_{cd}^{11}} \frac{\partial \Sigma^{11}_{cd}}{\partial H^1_{ij}}
\end{align*}

Really the first part is easy. 
\[\sum_{ab, a\neq b}\nabla^{11}_{ab} \sum_{cd}\frac{\partial \hat\Sigma_{ab}^{11}}{\partial \Sigma_{cd}^{11}} \frac{\partial \Sigma^{11}_{cd}}{\partial H^1_{ij}}= (1-s)\sum_{ab, a\neq b}\nabla^{11}_{ab} \frac{\partial\Sigma^{11}_{ab}}{\partial H^1_{ij}}\]

The second part is a little tougher, but not too bad
\begin{align*}
\sum_{a}\nabla^{11}_{aa} \sum_{cd}\frac{\partial \hat\Sigma_{aa}^{11}}{\partial \Sigma_{cd}^{11}} \frac{\partial \Sigma^{11}_{cd}}{\partial H^1_{ij}}
&= \sum_{a}\nabla^{11}_{aa} \left(\sum_{cd, c\neq d}\frac{\partial \hat\Sigma_{aa}^{11}}{\partial \Sigma_{cd}^{11}} \frac{\partial \Sigma^{11}_{cd}}{\partial H^1_{ij}}
  +\sum_{c}\frac{\partial\hat\Sigma_{aa}^{11}}{\partial\Sigma_{cc}^{11}} \frac{\partial\Sigma^{11}_{cc}}{\partial H^1_{ij}}\right)\\
&=  \sum_{a}\nabla^{11}_{aa} \left(0
+ \sum_{c}\frac{\partial\hat\Sigma_{aa}^{11}}{\partial\Sigma_{cc}^{11}} \frac{\partial\Sigma^{11}_{cc}}{\partial H^1_{ij}}\right)\\
&=  \sum_{a}\nabla^{11}_{aa} \sum_{c}\frac{\partial\hat\Sigma_{aa}^{11}}{\partial\Sigma_{cc}^{11}} \frac{\partial\Sigma^{11}_{cc}}{\partial H^1_{ij}}\\
&=  \sum_{a}\nabla^{11}_{aa} \left(\frac{s}{D}\sum_{c}\frac{\partial\Sigma^{11}_{cc}}{\partial H^1_{ij}} + (1-s)\frac{\partial\Sigma^{11}_{aa}}{\partial H^1_{ij}}\right)\\
&= \frac{s}{D} \left(\sum_{a}\nabla^{11}_{aa} \sum_{c}\frac{\partial\Sigma^{11}_{cc}}{\partial H^1_{ij}}\right)
  + (1-s)\left(\sum_{a}\nabla^{11}_{aa}\frac{\partial\Sigma^{11}_{aa}}{\partial H^1_{ij}}\right)\\
&= \frac{s}{D} \left(\sum_{a}\nabla^{11}_{aa} \sum_{c}\frac{\partial\Sigma^{11}_{cc}}{\partial H^1_{ij}}\right)
+ (1-s)\left(\sum_{a}\nabla^{11}_{aa}\frac{\partial\Sigma^{11}_{aa}}{\partial H^1_{ij}}\right)
\end{align*}

Put the two parts together, we get 
\[\sum_{ab}\nabla^{11}_{ab} \sum_{cd}\frac{\partial \hat\Sigma_{ab}^{11}}{\partial \Sigma_{cd}^{11}} \frac{\partial \Sigma^{11}_{cd}}{\partial H^1_{ij}}
= (1 - s) \sum_{ab}\nabla_{ab}^{11}\frac{\partial \Sigma_{ab}^{11}}{\partial H^1_{ij}} + \frac{s}{D}\cdot \sum_{a}\nabla^{11}_{aa} \sum_{c}\frac{\partial\Sigma^{11}_{cc}}{\partial H^1_{ij}}
\]

Put the first term and the second term together, we get
\[\frac{\partial f}{\partial H^1_{ij}} = (1 - s) \sum_{ab}\nabla_{ab}^{11}\frac{\partial \Sigma_{ab}^{11}}{\partial H^1_{ij}} + \frac{s}{D}\cdot \sum_{a}\nabla^{11}_{aa} \sum_{c}\frac{\partial\Sigma^{11}_{cc}}{\partial H^1_{ij}} + \sum_{ab} \nabla^{12}_{ab}\frac{\partial\hat\Sigma^{12}_{ab}}{\partial H^1_{ij}}\]

Since 
\[\frac{\partial\Sigma^{11}_{ab}}{\partial H^1_{ij}} = \frac{1}{m} (\delta_{ai}\bar H^1_{bj} + \delta_{bi}\bar H^1_{aj})\]

We know,
\begin{align*}
\frac{s}{D}\cdot \sum_{a}\nabla^{11}_{aa} \sum_{c}\frac{\partial\Sigma^{11}_{cc}}{\partial H^1_{ij}}
&= \frac{s}{D}\cdot \frac{2}{m} \sum_{a}\nabla^{11}_{aa} \bar H^1_{ij}\\
&= \frac{s}{D}\cdot \frac{2}{m} \bar H^1_{ij} \text{tr}(\nabla^{11})
\end{align*}

As a result,
\begin{align*}
  \frac{\partial f}{\partial H^1_{ij}}
&= \frac{1}{m}((1-s) (\nabla_{11}\bar H_1)_{ij} + (1-s) (\nabla'_{11}\bar H_1)_{ij} + (\nabla_{12}\bar H_2)_{ij} + 2s\cdot \frac{\text{tr}(\nabla_{11})}{D}\bar H^1_{ij})
\end{align*}

\begin{align*}
  \frac{\partial f}{\partial H_1}
&= \frac{1}{m} (2(1-s) \nabla_{11}\bar H_1 + 2s\frac{\text{tr}(\nabla_{11})}{D} \bar H_1 + \nabla_{12}\bar H_2)\\
&= \frac{1}{m} (2 \nabla_{11}\bar H_1 + \nabla_{12}\bar H_2)
  + \frac{1}{m} (2s(\frac{\text{tr}(\nabla_{11})}{D}I - \nabla_{11}) \bar H_1)
\end{align*}

\end{document}
